#!/usr/bin/env python3
"""
Create a SuperKit by merging multiple DNA test formats.

Combines SNPs from:
- 23andMe format (rsid, chromosome, position, genotype)
- AncestryDNA format (rsid, chromosome, position, allele1, allele2)
- MyHeritage format (CSV: RSID, CHROMOSOME, POSITION, RESULT)

Output: 23andMe-compatible format with all unique SNPs (~1.2-1.4M)
"""

import os
import sys
import csv
from datetime import datetime
from collections import OrderedDict


def parse_23andme(filepath):
    """Parse 23andMe format file."""
    snps = {}
    with open(filepath, 'r') as f:
        for line in f:
            if line.startswith('#') or not line.strip():
                continue
            parts = line.strip().split('\t')
            if len(parts) >= 4:
                rsid, chrom, pos, genotype = parts[0], parts[1], parts[2], parts[3]
                if rsid.startswith('rs'):
                    snps[rsid] = (chrom, pos, genotype)
    return snps


def parse_ancestry(filepath):
    """Parse AncestryDNA format file (separate allele columns)."""
    snps = {}
    with open(filepath, 'r') as f:
        for line in f:
            if line.startswith('#') or line.startswith('rsid'):
                continue
            parts = line.strip().split('\t')
            if len(parts) >= 5:
                rsid, chrom, pos, allele1, allele2 = parts[0], parts[1], parts[2], parts[3], parts[4]
                if rsid.startswith('rs'):
                    genotype = allele1 + allele2
                    snps[rsid] = (chrom, pos, genotype)
    return snps


def parse_myheritage(filepath):
    """Parse MyHeritage CSV format."""
    snps = {}
    with open(filepath, 'r') as f:
        reader = csv.reader(f)
        for row in reader:
            # Skip comments and header
            if not row or row[0].startswith('#') or row[0] == 'RSID':
                continue
            if len(row) >= 4:
                rsid, chrom, pos, genotype = row[0], row[1], row[2], row[3]
                # Remove quotes if present
                rsid = rsid.strip('"')
                if rsid.startswith('rs'):
                    snps[rsid] = (chrom, pos, genotype)
    return snps


def merge_snps(*snp_dicts):
    """Merge multiple SNP dictionaries, keeping first occurrence for conflicts."""
    merged = OrderedDict()

    for snp_dict in snp_dicts:
        for rsid, data in snp_dict.items():
            if rsid not in merged:
                merged[rsid] = data

    return merged


def sort_snps(snps):
    """Sort SNPs by chromosome and position."""
    def sort_key(item):
        rsid, (chrom, pos, genotype) = item
        # Handle chromosome ordering (1-22, X, Y, MT)
        try:
            if chrom == 'X':
                chrom_num = 23
            elif chrom == 'Y':
                chrom_num = 24
            elif chrom in ('MT', 'M'):
                chrom_num = 25
            else:
                chrom_num = int(chrom)
            pos_num = int(pos)
        except ValueError:
            chrom_num = 99
            pos_num = 0
        return (chrom_num, pos_num)

    return OrderedDict(sorted(snps.items(), key=sort_key))


def write_23andme_format(snps, output_path, source_info):
    """Write SNPs in 23andMe format."""
    with open(output_path, 'w') as f:
        f.write(f"# SuperKit generated by DNA Project merger\n")
        f.write(f"# Created: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        f.write(f"# Sources: {source_info}\n")
        f.write(f"# Total unique SNPs: {len(snps):,}\n")
        f.write("#\n")
        f.write("# This file contains merged genotype data from multiple sources.\n")
        f.write("# Format: rsid<TAB>chromosome<TAB>position<TAB>genotype\n")
        f.write("# Reference: GRCh37 (hg19)\n")
        f.write("#\n")
        f.write("# rsid\tchromosome\tposition\tgenotype\n")

        for rsid, (chrom, pos, genotype) in snps.items():
            f.write(f"{rsid}\t{chrom}\t{pos}\t{genotype}\n")


def main():
    # Default paths
    base_dir = "/Volumes/T7 Touch/Downloads/drive.usercontent.google.com/extracted"
    output_dir = "/Volumes/T7 Touch/Downloads/drive.usercontent.google.com"

    # Input files
    files = {
        '23andMe': os.path.join(base_dir, 'genome_Andrzej_Zak_v5_Full_20220922004349.txt'),
        'AncestryDNA': os.path.join(base_dir, 'AncestryDNA.txt'),
        'MyHeritage': os.path.join(base_dir, 'MyHeritage_raw_dna_data.csv'),
    }

    # Output file
    output_path = os.path.join(output_dir, 'APR_SuperKit_Combined.txt')

    print("=" * 60)
    print("SuperKit Generator - Merging DNA Test Results")
    print("=" * 60)

    # Parse each file
    all_snps = {}
    counts = {}

    for name, filepath in files.items():
        if not os.path.exists(filepath):
            print(f"Warning: {name} file not found: {filepath}")
            continue

        print(f"\nParsing {name}...")

        if name == '23andMe':
            snps = parse_23andme(filepath)
        elif name == 'AncestryDNA':
            snps = parse_ancestry(filepath)
        elif name == 'MyHeritage':
            snps = parse_myheritage(filepath)

        counts[name] = len(snps)
        all_snps[name] = snps
        print(f"  Found {len(snps):,} SNPs")

    if not all_snps:
        print("Error: No input files found!")
        sys.exit(1)

    # Merge SNPs (23andMe first as primary, then others fill gaps)
    print("\nMerging SNPs...")
    merged = merge_snps(
        all_snps.get('23andMe', {}),
        all_snps.get('AncestryDNA', {}),
        all_snps.get('MyHeritage', {}),
    )

    # Sort by chromosome and position
    print("Sorting by genomic position...")
    sorted_snps = sort_snps(merged)

    # Calculate overlap statistics
    print("\n" + "-" * 40)
    print("MERGE STATISTICS")
    print("-" * 40)

    for name, count in counts.items():
        print(f"{name:15} : {count:>10,} SNPs")

    print("-" * 40)
    total_input = sum(counts.values())
    unique = len(sorted_snps)
    overlap = total_input - unique

    print(f"{'Total input':15} : {total_input:>10,} SNPs")
    print(f"{'Overlap':15} : {overlap:>10,} SNPs")
    print(f"{'Unique merged':15} : {unique:>10,} SNPs")
    print("-" * 40)

    # Write output
    print(f"\nWriting SuperKit to: {output_path}")
    source_info = ", ".join([f"{k} ({v:,})" for k, v in counts.items()])
    write_23andme_format(sorted_snps, output_path, source_info)

    # File size
    size_mb = os.path.getsize(output_path) / (1024 * 1024)
    print(f"Output size: {size_mb:.1f} MB")

    print("\n" + "=" * 60)
    print("SUCCESS! SuperKit created.")
    print("=" * 60)
    print(f"\nOutput file: {output_path}")
    print(f"Total SNPs:  {unique:,}")
    print(f"\nThis file can be uploaded to:")
    print("  - MyTrueAncestry (23andMe format)")
    print("  - GEDmatch (23andMe format)")
    print("  - DNA.Land")
    print("  - Any service accepting 23andMe format")

    return 0


if __name__ == '__main__':
    sys.exit(main())
